{% extends 'base.html'%}

{% block title %} Pesquisar Assinantes {% endblock %}

{% block content %}
<script>
	$(document).ready(function () {
		$('.container').removeClass('container');
	});
	setGenPasswordToFields(['id_{{user_form.password1.name}}', 'id_{{user_form.password2.name}}']);
</script>


<div class="content">
	<div class="container-fluid">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title">Filtros de Assinantes</h4>
			</div>
			<div class="card-body">
				<div class="form-group">
					<form id="myForm" method="POST" enctype="multipart/form-data"
						data-urlclasses="{% url 'users:classes_choices_ajax' %}"> {% csrf_token %}
						<div class="row">
							<div class="labelandform col-md-6">
								<p><label>Selecione a Escola:</label></p>
								<select class="custom-select chosen-select" id="select_form_school">
									<option id="" value="">Todas</option>
									{% for school in schools %}
									<option value="{{ school.school_id }}"
										{% if school.school_id == query.selected_school %} selected {% endif %}>
										{{ school.school_name }}
									</option>
									{% endfor %}
								</select>
							</div>
							<div class="labelandform col-md-6">
								<p><label>Selecione a Turma:</label></p>
								<select class="custom-select chosen-select" id="select_form_class">
									<option id="" value="0" selected>--------</option>
								</select>
							</div>
							<input type="hidden" id="selected_school" name="selected_school">
							<input type="hidden" id="selected_class" name="selected_class">
						</div>
						<div class="row">
							<div class="labelandform col-md-12">
								<p><label>Tipo de Usuário:</label></p>
								<select class="custom-select chosen-select" id="select_form">
									<option id="" value="" selected>Todos</option>
									<option value="parent" {% if query.type_of_user == 'parent' %} selected {% endif %}>
										Responsáveis</option>
									<option value="student" {% if query.type_of_user == 'student' %} selected
										{% endif %}>Estudante</option>
								</select>
							</div>
						</div>
						<input type="text" id="name" name="name" placeholder="Insira o nome do usuário aqui..."
							value="{{query.name}}">
						<input type="hidden" id="type_of_user" name="type_of_user">
						<p class="text-warning">{{error}}</p>
						<div style="margin-top: 10px">
							<button class="btn btn-info btn-fill pull-left" type="submit"
                                style="background-color: #3CB371; border-color: #3CB371">Buscar</button>
                            <input type="button" onClick="limpa()" class="btn btn-info btn-fill pull-left"
                                style="background-color: #B22222; border-color: #B22222; margin-left: 30px;"
								value="Limpar" />
							<input type="button" onClick="exportTableToCSV('Assinantes.csv')" class="btn btn-info btn-fill pull-left"
                                style="background-color: #1D23D7; border-color: #1D23D7; margin-left: 30px;"
                                value="Exportar" />
						</div>

					</form>
				</div>

			</div>
		</div>
	</div>
	<div class="content">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div class="card strpied-tabled-with-hover">
						<div class="card-header ">
							<h4 class="card-title">Resultados</h4>
						</div>
						<div class="card-body table-full-width table-responsive">
							<table class="table table-hover table-striped display mb-4" id="headstable">
								<thead>
									<tr>
										{% if query.type_of_user == 'student' or not query.type_of_user %}
											<th>Escolas</th>
										{% elif query.type_of_user == 'parent' %}
											<th>Escolas</th>
										{% endif %}
										<th>Nome</th>
										{% if query.type_of_user == 'student' or not query.type_of_user %}
											<th>Turmas</th>
											<th>Responsáveis</th>
										{% endif %}
										<th>Ações</th>
									</tr>
								</thead>
								{% if school_users %}
								<tbody class="">
									{% for user in school_users %}
									<tr>
										<td>
											<div class="container" style="white-space: nowrap; text-align: center">
												{% for school in user.school_set.all %}
													<div class="row" style="margin-bottom: 10px">
														<div class="col-md-12">
															{{ school.school_name }}
														</div>
													</div>
												{% endfor %}
												{% if user.first_parent.all or user.second_parent.all or user.third_parent.all %}
													<div class="row" style="margin-bottom: 10px">
														<div class="col-md-12">
															{{ user.school_name }}
														</div>
													</div>
												{% endif %}
											</div>
										</td>
										<th>{{ user.name }}</th>
										{% if query.type_of_user == 'student' or not query.type_of_user %}
											<td>
												<div class="container" style="white-space: nowrap; text-align: center">
													{% for classe in user.class_set.all %}
														<div class="row" style="margin-bottom: 10px">
															<div class="col-md-12">
																{{ classe.class_name }}
															</div>
														</div>
													{% endfor %}
												</div>
											</td>
											<td>
												{% if user.first_parent.all or user.second_parent.all or user.third_parent.all %}
												{% else %}
													<div class="container" style="white-space: nowrap; text-align: center">
														{% if user.first_parent %}
															<div class="row" style="margin-bottom: 10px">
																<div class="col-md-12">
																	{{ user.first_parent.name }}
																</div>
															</div>
														{% endif %}
														{% if user.second_parent %}
															<div class="row" style="margin-bottom: 10px">
																<div class="col-md-12">
																	{{ user.second_parent.name }}
																</div>
															</div>
														{% endif %}
														{% if user.third_parent %}
															<div class="row" style="margin-bottom: 10px">
																<div class="col-md-12">
																	{{ user.third_parent.name }}
																</div>
															</div>
														{% endif %}
													</div>
												{% endif %}
											</td>
										{% endif %}
										<th>
											<div class="dropdown show">
												<button type="button" class="btn btn-secondary" id="dropdownMenuLink"
													data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i
														class="fas fa-ellipsis-h"></i></button>
			
			
												<div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
													{% if user.first_parent.all or user.second_parent.all or user.third_parent.all %}
													{% else %}
															<a href="{% url 'users:set_parents' user.student_id %}"
																data-baloon="Remove this item from the cart"
																class="dropdown-item">
																Selecionar Responsáveis
															</a>
													{% endif %}
													{% if user.profile %}
														<a href="{% url 'users:change_email' user.profile.id %}"
														data-baloon="Remove this item from the cart"
														class="dropdown-item">Atualizar Email</a>
														{% if user.first_parent.all or user.second_parent.all or user.third_parent.all %}
														<a href="{% url 'users:reset_password_send_email' user.parent_id 'parent' %}"
															data-baloon="Remove this item from the cart"
															class="dropdown-item">Resetar Senha</a>
														{% else %}
														<a href="{% url 'users:reset_password_send_email' user.student_id 'student' %}"
															data-baloon="Remove this item from the cart"
															class="dropdown-item">Resetar Senha</a>
														{% endif %}
													{% endif %}
													{% if user.first_parent.all or user.second_parent.all or user.third_parent.all %}
														<a class="dropdown-item"
															onclick="changeYesLink('{% url 'users:delete_user' user.parent_id 'parent' %}')"
															href="#" data-baloon="Remove this item from the cart"
															class="text-light" data-toggle="modal"
															data-target="#delete-assinante-modal">
															Deletar Responsável
														</a>
													{% else %}
														<a class="dropdown-item"
															onclick="changeYesLink('{% url 'users:delete_user' user.student_id 'student' %}')"
															href="#" data-baloon="Remove this item from the cart"
															class="text-light" data-toggle="modal"
															data-target="#delete-assinante-modal">
															Deletar Estudante
														</a>
													{% endif %}
												</div>
											</div>
										</th>
									</tr>
									{% endfor %}
								</tbody>
								{% endif %}
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		function limpa() {
            document.getElementById('selected_school').value = "";
            document.getElementById('selected_class').value = "";
			document.getElementById('type_of_user').value = "";
			document.getElementById('name').value = "";
            $('#select_form_school')
                .find('option:first-child').prop('selected', true)
                .end().trigger('chosen:updated');
            $('#select_form_class').html(`<option id="" value="0">--------</option>`)
            $('#select_form_class')
                .find('option:first-child').prop('selected', true)
                .end().trigger('chosen:updated');
			$('#select_form')
                .find('option:first-child').prop('selected', true)
                .end().trigger('chosen:updated');
        }
		$(document).ready(function () {
            jQuery(window).on('resize', function () {
				$("#select_form_school_chosen").attr('style', 'width: 100%');
				$("#select_form_class_chosen").attr('style', 'width: 100%');
				$("#select_form_chosen").attr('style', 'width: 100%');
            });
        });
		$(document).ready(function () {
			$('#select_form_school').on('change', function () {
				let urlClasses = $('#myForm').data('urlclasses')
				var selectValor = $(this).val();
				$.ajax({
					url: urlClasses,
					data: {
						id: selectValor
					},
					success: function (response) {
						$('#select_form_class').html(response);
						$('#select_form_class').trigger("chosen:updated");
					}
				})
				if (selectValor == '') {
					document.getElementById('selected_school').value = '0'
				}
				else {
					document.getElementById('selected_school').value = selectValor
				}
			});
		});
		$(document).ready(function () {
			$('#select_form_class').on('change', function () {
				var selectValor = $(this).val();
				if (selectValor == '') {
					document.getElementById('selected_class').value = '0'
				}
				else {
					document.getElementById('selected_class').value = selectValor
				}
			});
		});
		$(document).ready(function () {
			$('#select_form').on('change', function () {
				setGenPasswordToFields(['id_{{user_form.password1.name}}', 'id_{{user_form.password2.name}}']);
				var selectValor = $(this).val();
				if (selectValor == '') {
					document.getElementById('type_of_user').value = ''
				}
				else {
					document.getElementById('type_of_user').value = selectValor
				}
			});
		});
		$(document).ready(function () {

			$('#headstablebutton').addClass('non-interactable');
			$('#headstable').DataTable({
				initComplete: function () {
					$('#headstablebutton').removeClass('non-interactable');
				}
			});
		});
		function changeYesLink(url) {
			document.getElementById("link_to_delete").href = url;
		};
	</script>
	<div id="delete-assinante-modal" class="modal fade" role="dialog">
		<div class="modal-dialog">

			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">x</span>
					</button>
				</div>
				<div class="modal-body">
					<p>Você tem certeza que deseja deletar este assinante? Essa operação não pode ser desfeita!</p>
				</div>
				<div class="modal-footer">
					<a id="link_to_delete" class="btn btn-danger btn-block" href="">Sim</a>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Não</button>
				</div>
			</div>

		</div>
	</div>

	{% endblock %}